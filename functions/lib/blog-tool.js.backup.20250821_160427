const functions = require('firebase-functions');
const xmlrpc = require('xmlrpc');
const { OpenAI } = require('openai');

class BlogTool {
  constructor() {
    // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã‚’å–å¾—
    this.wordpressUrl = process.env.WORDPRESS_URL || functions.config().wordpress?.url || 'https://www.entamade.jp';
    this.wordpressUsername = process.env.WORDPRESS_USERNAME || functions.config().wordpress?.username;
    this.wordpressPassword = process.env.WORDPRESS_PASSWORD || functions.config().wordpress?.password;
    this.openaiApiKey = process.env.OPENAI_API_KEY || functions.config().openai?.api_key;

    if (!this.openaiApiKey) {
      throw new Error('OpenAI API key not configured');
    }

    console.log('âœ… BlogTool initialized successfully');

    this.openai = new OpenAI({
      apiKey: this.openaiApiKey
    });

    // XML-RPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®š
    if (this.wordpressUrl) {
      const url = new URL(this.wordpressUrl);
      this.client = xmlrpc.createClient({
        host: url.hostname,
        port: url.port || 443,
        path: '/xmlrpc.php',
        secure: url.protocol === 'https:'
      });
    }

    this.blogId = 1;
  }

  // XMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  escapeXML(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&apos;');
  }

  // SEOã‚¿ã‚¤ãƒˆãƒ«æœ€é©åŒ–
  optimizeTitle(title, category) {
    const year = new Date().getFullYear();
    const month = new Date().getMonth() + 1;
    const day = new Date().getDate();
    
    // æ—¢ã«å¹´ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã®ã¿è¿½åŠ 
    if (!title.includes(year.toString())) {
      title = `ã€${year}å¹´${month}æœˆã€‘${title}`;
    }
    
    return title;
  }

  // SEOã‚¿ã‚°æœ€é©åŒ–
  optimizeTags(tags, category) {
    const baseTags = tags || [];
    const categoryTags = {
      entertainment: ['ã‚¨ãƒ³ã‚¿ãƒ¡', 'èŠ¸èƒ½', 'è©±é¡Œ', 'ãƒˆãƒ¬ãƒ³ãƒ‰'],
      anime: ['ã‚¢ãƒ‹ãƒ¡', 'ã‚ªã‚¿ã‚¯', 'å£°å„ª', 'æ–°ä½œ'],
      game: ['ã‚²ãƒ¼ãƒ ', 'eã‚¹ãƒãƒ¼ãƒ„', 'æ”»ç•¥', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼'],
      movie: ['æ˜ ç”»', 'æ´‹ç”»', 'é‚¦ç”»', 'Netflix'],
      music: ['éŸ³æ¥½', 'J-POP', 'æ–°æ›²', 'ãƒ©ã‚¤ãƒ–'],
      tech: ['ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼', 'IT', 'ã‚¬ã‚¸ã‚§ãƒƒãƒˆ', 'AI'],
      beauty: ['ç¾å®¹', 'ã‚³ã‚¹ãƒ¡', 'ã‚¹ã‚­ãƒ³ã‚±ã‚¢', 'ãƒ¡ã‚¤ã‚¯'],
      food: ['ã‚°ãƒ«ãƒ¡', 'æ–™ç†', 'ãƒ¬ã‚·ãƒ”', 'é£Ÿã¹ç‰©']
    };
    
    const additionalTags = categoryTags[category] || [];
    const year = new Date().getFullYear();
    
    return [...new Set([
      ...baseTags,
      ...additionalTags,
      'æœ€æ–°æƒ…å ±',
      `${year}å¹´`,
      'ã¾ã¨ã‚',
      'ãƒ©ãƒ³ã‚­ãƒ³ã‚°',
      'æ³¨ç›®'
    ])].slice(0, 15); // æœ€å¤§15å€‹ã®ã‚¿ã‚°
  }

  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
  sanitizeContent(content) {
    if (!content) return '';
    
    // å±é™ºãªã‚¿ã‚°ã‚’é™¤å»
    let safe = String(content)
      .replace(/<script[^>]*>.*?<\/script>/gi, '')
      .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '')
      .replace(/<object[^>]*>.*?<\/object>/gi, '')
      .replace(/<embed[^>]*>/gi, '');
    
    // æ–‡å­—æ•°åˆ¶é™ï¼ˆå®‰å…¨ã®ãŸã‚1500æ–‡å­—ã«åˆ¶é™ï¼‰
    if (safe.length > 1500) {
      safe = safe.substring(0, 1500) + '...';
    }
    
    return safe;
  }

  // XML-RPCå‘¼ã³å‡ºã—
  async callXmlRpc(methodName, params) {
    return new Promise((resolve, reject) => {
      this.client.methodCall(methodName, params, (error, value) => {
        if (error) {
          console.error(`XML-RPC Error calling ${methodName}:`, error);
          reject(error);
        } else {
          resolve(value);
        }
      });
    });
  }

  // WordPressã«æŠ•ç¨¿
  async postToWordPress(title, content, options = {}) {
    try {
      console.log('ğŸ“¤ Posting to WordPress via XML-RPC...');
      
      // SEOæœ€é©åŒ–
      const seoTitle = this.optimizeTitle(title, options.category);
      const seoTags = this.optimizeTags(options.tags, options.category);
      
      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å®‰å…¨åŒ–
      const safeContent = this.sanitizeContent(content);
      
      const postData = {
        post_type: 'post',
        post_status: options.status || 'publish',
        post_title: this.escapeXML(seoTitle),
        post_content: safeContent,
        post_author: 1,
        comment_status: 'open',
        ping_status: 'open',
        sticky: false,
        post_format: 'standard',
        terms_names: {
          category: [options.category || 'ã‚¨ãƒ³ã‚¿ãƒ¡'],
          post_tag: seoTags
        }
      };

      if (options.excerpt) {
        postData.post_excerpt = this.escapeXML(options.excerpt);
      }

      const result = await this.callXmlRpc('wp.newPost', [
        this.blogId,
        this.wordpressUsername,
        this.wordpressPassword,
        postData
      ]);

      console.log('âœ… WordPress post created with ID:', result);
      
      return {
        success: true,
        postId: result,
        url: `${this.wordpressUrl}/?p=${result}`,
        message: 'Post created successfully'
      };
      
    } catch (error) {
      console.error('âŒ Error posting to WordPress:', error);
      return {
        success: false,
        error: error.message,
        message: 'Failed to create post'
      };
    }
  }

  // è¨˜äº‹ç”Ÿæˆï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ï¼‰
  async generateArticle(category = 'entertainment', options = {}) {
    try {
      console.log(`ğŸ” Generating ${category} article...`);
      
      const templates = {
        entertainment: 'æœ€æ–°ã®ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€èŠ¸èƒ½äººã®è©±é¡Œã€ãƒ†ãƒ¬ãƒ“ç•ªçµ„æƒ…å ±',
        anime: 'æ³¨ç›®ã®ã‚¢ãƒ‹ãƒ¡ä½œå“ã€å£°å„ªæƒ…å ±ã€ã‚¢ãƒ‹ãƒ¡ã‚¤ãƒ™ãƒ³ãƒˆ',
        game: 'äººæ°—ã‚²ãƒ¼ãƒ ã®æ”»ç•¥æƒ…å ±ã€æ–°ä½œã‚²ãƒ¼ãƒ æƒ…å ±ã€eã‚¹ãƒãƒ¼ãƒ„',
        movie: 'è©±é¡Œã®æ˜ ç”»ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€å…¬é–‹äºˆå®šä½œå“ã€æ˜ ç”»é¤¨æƒ…å ±',
        music: 'æœ€æ–°éŸ³æ¥½ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€æ–°æ›²ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã€ãƒ©ã‚¤ãƒ–æƒ…å ±',
        tech: 'ITæ¥­ç•Œãƒ‹ãƒ¥ãƒ¼ã‚¹ã€æœ€æ–°ã‚¬ã‚¸ã‚§ãƒƒãƒˆã€AIæŠ€è¡“',
        beauty: 'ç¾å®¹ãƒˆãƒ¬ãƒ³ãƒ‰ã€ã‚¹ã‚­ãƒ³ã‚±ã‚¢æ–¹æ³•ã€ãƒ¡ã‚¤ã‚¯ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯',
        food: 'ã‚°ãƒ«ãƒ¡æƒ…å ±ã€äººæ°—ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã€ãƒ¬ã‚·ãƒ”ç´¹ä»‹'
      };

      const topic = templates[category] || templates.entertainment;
      
      const prompt = `
${topic}ã«ã¤ã„ã¦ã€æœ€æ–°ã®æƒ…å ±ã‚’ã¾ã¨ã‚ãŸé­…åŠ›çš„ãªãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

è¦ä»¶:
1. 1200-1500æ–‡å­—ç¨‹åº¦
2. HTMLå½¢å¼ï¼ˆh2, h3, p, ul, liã‚¿ã‚°ã‚’ä½¿ç”¨ï¼‰
3. SEOã‚’æ„è­˜ã—ãŸæ§‹æˆ
4. èª­è€…ã®èˆˆå‘³ã‚’å¼•ãå†…å®¹
5. å…·ä½“çš„ãªæƒ…å ±ã‚’å«ã‚ã‚‹

æ§‹æˆ:
- å°å…¥éƒ¨åˆ†ï¼ˆãªãœä»Šã“ã®è©±é¡ŒãŒé‡è¦ã‹ï¼‰
- ãƒ¡ã‚¤ãƒ³ãƒˆãƒ”ãƒƒã‚¯3ã¤ï¼ˆãã‚Œãã‚Œh2ã‚¿ã‚°ï¼‰
- ã¾ã¨ã‚

HTMLå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
`;

      const completion = await this.openai.chat.completions.create({
        model: "gpt-4o-mini",
        messages: [
          {
            role: "system",
            content: "ã‚ãªãŸã¯äººæ°—ãƒ–ãƒ­ã‚°ã®è¨˜è€…ã§ã™ã€‚SEOã«å¼·ãã€èª­è€…ã‚’å¼•ãä»˜ã‘ã‚‹è¨˜äº‹ã‚’æ›¸ãã¾ã™ã€‚"
          },
          {
            role: "user",
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 2000
      });

      const content = completion.choices[0]?.message?.content || '';
      
      // ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
      const titlePrompt = `ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€SEOã«å¼·ã„é­…åŠ›çš„ãªè¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’1ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚30-50æ–‡å­—ç¨‹åº¦ã€‚`;
      
      const titleCompletion = await this.openai.chat.completions.create({
        model: "gpt-4o-mini",
        messages: [
          {
            role: "user",
            content: titlePrompt
          }
        ],
        temperature: 0.8,
        max_tokens: 100
      });

      const title = titleCompletion.choices[0]?.message?.content?.trim() || `${category}ã®æœ€æ–°æƒ…å ±`;

      console.log('âœ… Article generated successfully');
      
      return {
        title: title,
        content: content,
        category: category,
        tags: this.optimizeTags([], category)
      };
      
    } catch (error) {
      console.error('âŒ Error generating article:', error);
      throw error;
    }
  }

  // å•†å“ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨˜äº‹ç”Ÿæˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
  async generateProductReviewArticle(productData, keyword) {
    try {
      console.log('ğŸ” Generating product review article...');
      
      const prompt = `
å•†å“ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

å•†å“æƒ…å ±:
- ã‚¿ã‚¤ãƒˆãƒ«: ${productData.title || 'å•†å“å'}
- èª¬æ˜: ${productData.description || ''}
- ä¾¡æ ¼: ${productData.price || ''}
- ã‚«ãƒ†ã‚´ãƒª: ${productData.category || ''}

ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keyword || ''}

HTMLå½¢å¼ã§1200-1500æ–‡å­—ã®è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
æ§‹æˆï¼šå°å…¥ã€ç‰¹å¾´ã€ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã€ã¾ã¨ã‚
`;

      const completion = await this.openai.chat.completions.create({
        model: "gpt-4o-mini",
        messages: [
          {
            role: "system",
            content: "ã‚ãªãŸã¯å•†å“ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å°‚é–€å®¶ã§ã™ã€‚"
          },
          {
            role: "user",
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 2000
      });

      const content = completion.choices[0]?.message?.content || '';
      const title = `${productData.title}ã®è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€${new Date().getFullYear()}å¹´æœ€æ–°ã€‘`;
      
      return {
        title: title,
        content: content,
        category: productData.category || 'ãƒ¬ãƒ“ãƒ¥ãƒ¼',
        tags: [keyword, 'å•†å“ãƒ¬ãƒ“ãƒ¥ãƒ¼', 'æœ€æ–°']
      };
      
    } catch (error) {
      console.error('âŒ Error generating product review:', error);
      // ã‚¨ãƒ©ãƒ¼ã§ã‚‚åŸºæœ¬çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¿”ã™
      return {
        title: productData.title || 'ã‚¨ãƒ©ãƒ¼',
        content: '<p>è¨˜äº‹ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>',
        category: 'ã‚¨ãƒ©ãƒ¼',
        tags: []
      };
    }
  }
}

// BlogAutomationToolã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
class BlogAutomationTool extends BlogTool {
  constructor() {
    super();
    console.log('BlogAutomationTool initialized (alias for BlogTool)');
  }
}

module.exports = BlogTool;
module.exports.BlogAutomationTool = BlogAutomationTool;